<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>理解跳跃表skiplist | reallocvoid</title>
  <meta name="author" content="xuangong">
  
  <meta name="description" content="跳跃表是一种随机化数据结构，基于并联的链表，其效率可以逼近二叉查找树，对于大多数操作需要O(logn)平均时间，并且对并发算法友好。
跳跃表对有序链表增加附加的前进链接，增加（Insert）是以随机化的方式进行的，所以可以快速的跳过部分列表，故以此得名。
她是很年轻的算法而且实现简单，深受广大程序员喜爱。

需要动态维护数据，有对数复杂度的插入、删除和查找性能，可以选择的数据结构很多，比如：

B-tree
Red-black tree
treap

如果要求一个小时完成程序，竟然还不给我们翻书，那咱们选择谁呢？OK，答案是我们今天的主人公：跳跃表skiplist
跳跃表按层构造的，让我们看一下redis中跳跃表的数据结构(redis.h)：">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="理解跳跃表skiplist"/>
  <meta property="og:site_name" content="reallocvoid"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/feed.xml" title="reallocvoid" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">reallocvoid</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/atom.xml">RSS</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-06-30T16:53:43.000Z"><a href="/2014/07/01/skiplist/">7月 1 2014</a></time>
      
      
  
    <h1 class="title">理解跳跃表skiplist</h1>
  

    </header>
    <div class="entry">
      
        <blockquote>
<p>跳跃表是一种随机化数据结构，基于<strong>并联的链表</strong>，其效率可以逼近二叉查找树，对于大多数操作需要O(logn)平均时间，并且对<strong>并发</strong>算法友好。
跳跃表对<strong>有序</strong>链表增加附加的前进链接，增加（Insert）是以随机化的方式进行的，所以可以快速的跳过部分列表，故以此得名。
她是很年轻的算法而且实现简单，深受广大程序员喜爱。</p>
</blockquote>
<p>需要动态维护数据，有对数复杂度的插入、删除和查找性能，可以选择的数据结构很多，比如：</p>
<ul>
<li>B-tree</li>
<li>Red-black tree</li>
<li>treap</li>
</ul>
<p>如果要求一个小时完成程序，竟然还不给我们翻书，那咱们选择谁呢？OK，答案是我们今天的主人公：跳跃表skiplist</p>
<p>跳跃表按层构造的，让我们看一下redis中跳跃表的数据结构(<a href="http://github.com/antirez/redis/blob/unstable/src/redis.h" target="_blank">redis.h</a>)：
<a id="more"></a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="comment">/*
 * 跳跃表
 */</span>
<span class="keyword">typedef</span> <span class="keyword">struct</span> zskiplist {
    <span class="comment">// 头节点，尾节点</span>
    <span class="keyword">struct</span> zskiplistNode *header, *tail;
    <span class="comment">// 节点数量</span>
    <span class="keyword">unsigned</span> <span class="keyword">long</span> length;
    <span class="comment">// 目前表内节点的最大层数</span>
    <span class="keyword">int</span> level;
} zskiplist;
</pre></td></tr></table></figure>



<p>而zskiplistNode的数据结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="comment">/* ZSETs use a specialized version of Skiplists */</span>
<span class="comment">/*
 * 跳跃表节点
 */</span>
<span class="keyword">typedef</span> <span class="keyword">struct</span> zskiplistNode {
    <span class="comment">// member 对象</span>
    robj *obj;
    <span class="comment">// 分值</span>
    <span class="keyword">double</span> score;
    <span class="comment">// 后退指针</span>
    <span class="keyword">struct</span> zskiplistNode *backward;
    <span class="comment">// 层</span>
    <span class="keyword">struct</span> zskiplistLevel {
        <span class="comment">// 前进指针</span>
        <span class="keyword">struct</span> zskiplistNode *forward;
        <span class="comment">// 这个层跨越的节点数量</span>
        <span class="keyword">unsigned</span> <span class="keyword">int</span> span;
    } level[];
} zskiplistNode;
</pre></td></tr></table></figure>


<p>zslCreate的时候tail直接为空，但是header是需要被创建并初始化为空的。数据结构中需要理解清楚的是span的含义，每个zskiplistNode的不同zskiplistLevel都有其独立的span，标识在这一层上，从该节点跳跃到下一个节点的步长:</p>
<ul>
<li>同一层的不同节点包含的span可以不同</li>
<li>新增一层时span直接初始化为跳表的长度</li>
</ul>
<p>Insert数据时，先给每一层定位插入节点的位置(从高层到低层查找)</p>
<p>跳跃表插入结构如图</p>
<p><img src="http://images.cnblogs.com/cnblogs_com/xuqiang/algorithm/skiplist_delete.png" alt="skiplist" title="insert-skiplist"></p>
<p>核心代码逻辑如下所示(<a href="https://github.com/antirez/redis/blob/unstable/src/t_zset.c" target="_blank">t_zset.c</a>)：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre>    x = zsl-&gt;header;
    <span class="comment">// 记录沿途访问的节点，并计数 span 等属性</span>
    <span class="comment">// 平均 O(log N) ，最坏 O(N)</span>
    <span class="keyword">for</span> (i = zsl-&gt;level-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {
        <span class="comment">/* store rank that is crossed to reach the insert position */</span>
        rank[i] = i == (zsl-&gt;level-<span class="number">1</span>) ? <span class="number">0</span> : rank[i+<span class="number">1</span>];

        <span class="comment">// 右节点不为空</span>
        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;                   
            <span class="comment">// 右节点的 score 比给定 score 小</span>
            (x-&gt;level[i].forward-&gt;score &lt; score ||      
                <span class="comment">// 右节点的 score 相同，但节点的 member 比输入 member 要小</span>
                (x-&gt;level[i].forward-&gt;score == score &amp;&amp; 
                compareStringObjects(x-&gt;level[i].forward-&gt;obj,obj) &lt; <span class="number">0</span>))) {
            <span class="comment">// 记录跨越了多少个元素</span>
            rank[i] += x-&gt;level[i].span;
            <span class="comment">// 继续向右前进</span>
            x = x-&gt;level[i].forward;
        }
        <span class="comment">// 保存访问节点</span>
        update[i] = x;
    }
</pre></td></tr></table></figure>


<p>先查找到最高层（最稀疏的层，直到发现右边元素比左边元素大时，记录该Node到update[level-1]），用保存节点的变量node x，定位x的下一层，继续查找。这样就可以用接近二叉查找树的性能找到各层需要插入位置的前邻近节点(第i层保存为update[i])，同时统计出各层预计插入位置前邻近节点已经跨越了多少个实际节点(逻辑上第0层的节点):rank[i]（从header后面真正的数据节点开始算）。</p>
<p>用很好的性能做好这样的准备工作以后，就开始真正的插入动作，插入时需要确定在哪一层插入，跳表采用的是随机化方法，插入在第i+1层的概率是出现在i层的1/p决定插入level的算法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="keyword">int</span> zslRandomLevel(<span class="keyword">void</span>) {
    <span class="keyword">int</span> level = <span class="number">1</span>;
    <span class="keyword">while</span> ((random()&amp;<span class="number">0xFFFF</span>) &lt; (ZSKIPLIST_P * <span class="number">0xFFFF</span>))
        level += <span class="number">1</span>;
    <span class="keyword">return</span> (level&lt;ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;
}
</pre></td></tr></table></figure>

<p>需要明确的是，在跳表中，虽然节点的指针很多，但是数据本身不会保存多份（<strong>共享的是一份数据</strong>）
节点中上层level的span是计算出来的（准确的说是由底层的信息计算出来的），计算的方法如下：</p>
<ul>
<li>我们容易得到各层距离插入点最近的节点跨越了多少节点（从header后面真正的数据节点开始算），即rank[i]。</li>
<li>我们知道已存在节点各层span（即节点跳跃到右边一步实际跨越多少个节点）</li>
</ul>
<p>操作有三种情况，假设插入一个节点选择的层是level，操作过程分一下几类情况：</p>
<ol>
<li>(level，zsl-&gt;level] 范围内，插入操作是不影响结构的，只需要更新这范围内各层中距离插入几点最近的节点中span的数字: <code>update[i].level[i].span++</code></li>
<li>[0, level] 范围内，插入节点是影响结构的，span的计算是用<code>update[i].level[i].span - (rank[i] - rank[0] ) + 1</code></li>
<li>(zsl-&gt;level, level] 范围内，说明这些层还没有被建立起来，这个范围内的各层需要设置<code>rank[i] = 0</code>(看作从header降层下来的)更新<code>update[i].span = zsl-&gt;length</code>同时 更新 <code>zsl-&gt;level = level</code>，范围就转化成了第2中情况</li>
</ol>
<p>理解跳跃表的核心部分就说完了，捋清楚插入的过程，查找和删除就非常容易了。Enjoy...</p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/algorithm/">algorithm</a>, <a href="/tags/data structure/">data structure</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
      <div id="fb-root"></div>
<script>
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=123456789012345";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

<div class="fb-comments" data-href="http://yoursite.com/2014/07/01/skiplist/" data-num-posts="5" data-width="840" data-colorscheme="light"></div>
      
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:yoursite.com">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/DP/">DP</a><small>1</small></li>
  
    <li><a href="/tags/algorithm/">algorithm</a><small>5</small></li>
  
    <li><a href="/tags/c/">c</a><small>1</small></li>
  
    <li><a href="/tags/data structure/">data structure</a><small>1</small></li>
  
    <li><a href="/tags/linux/">linux</a><small>1</small></li>
  
    <li><a href="/tags/personal/">personal</a><small>1</small></li>
  
    <li><a href="/tags/protocol/">protocol</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 xuangong
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>